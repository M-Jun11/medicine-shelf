<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>医薬品検索（パスワード付き）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; padding: 20px; }
    ul { list-style: none; padding: 0; }
    li { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
    li:hover { background-color: #f7f7f7; }
    small { color: #555; }
    .selected-item { margin-bottom: 6px; position: relative; padding-right: 20px; }
    .remove { color: red; margin-left: 10px; cursor: pointer; user-select: none; position: absolute; right: 4px; top: 0; font-weight: bold; }
    #selected, #savedData { margin-top: 20px; }
    .box { border: 1px solid #ccc; padding: 12px; margin-bottom: 12px; border-radius: 6px; }
    button { margin-right: 10px; margin-top: 10px; }
    .hint { color: #666; font-size: 12px; margin-top: 4px; }
    input[type="text"], input[type="password"] { width: 100%; max-width: 520px; padding: 8px; }
    /* 認証画面 */
    #auth { text-align: center; margin-top: 24px; }
    #main { display: none; }
  </style>
</head>
<body>
  <!-- 認証画面 -->
  <div id="auth">
    <h2>このページはパスワードで保護されています</h2>
    <input type="password" id="password" placeholder="パスワードを入力" />
    <button id="authBtn">認証</button>
    <p id="error" style="color:red;"></p>
  </div>

  <!-- アプリ本体 -->
  <div id="main">
    <h2>医薬品検索（最大20件まで選択可能）</h2>
    <input type="text" id="input" placeholder="例：一般名 または 品名（ひらがな入力OK）" />
    <div class="hint">例：どきさぞしん / あるふぁろーる / 「そくほうじょう」等もヒットします（ひらがな→カタカナ対応）</div>
    <ul id="suggestions"></ul>

    <h3>氏名を入力してください：</h3>
    <input type="text" id="personName" placeholder="氏名を入力"><br>

    <h3>選択された医薬品：</h3>
    <div id="selected"></div>
    <button id="saveBtn">保存</button>
    <button id="csvBtn">CSV出力</button>
    <button onclick="window.print()">印刷</button>
    <button id="resetBtn">TOPに戻る</button>

    <h3>保存されたデータ：</h3>
    <div id="savedData"></div>
  </div>

  <!-- 認証ロジック -->
  <script>
    const correctPassword = "321899"; // ←必要ならここを変更
    const $auth = document.getElementById("auth");
    const $main = document.getElementById("main");
    const $pwd  = document.getElementById("password");
    const $btn  = document.getElementById("authBtn");
    const $err  = document.getElementById("error");

    function unlock(){
      $auth.style.display = "none";
      $main.style.display = "block";
      sessionStorage.setItem("authed","1");
    }
    function checkPassword(){
      if ($pwd.value === correctPassword) unlock();
      else $err.textContent = "パスワードが違います。";
    }
    $btn.addEventListener("click", checkPassword);
    $pwd.addEventListener("keydown", e => { if (e.key === "Enter") checkPassword(); });
    if (sessionStorage.getItem("authed")==="1") unlock();
  </script>

  <!-- アプリのJS -->
  <script>
    // ====== RAW：ここに “そのまま” 行データを貼る（新旧フォーマット混在OK） ======
    const RAW = `

{ "一般名称": "アロチノロール塩酸塩錠", "後発/ジェネリック": "アロチノロール塩酸塩錠１０ｍｇ「サワイ」", "先発": "アロチノロール塩酸塩錠１０ｍｇ「ＤＳＰ」", "棚種類": "通常", "Note": "間違えやすい先発品" }
{ "一般名称": "白虎加人参湯エキス顆粒", "後発/ジェネリック": "なし", "先発": "０３４ツムラ白虎加人参湯エキス顆粒（医療用）", "棚種類": "通常", "Note": "ー" }
{ "一般名称": "白虎加人参湯エキス顆粒", "後発/ジェネリック": "ジアゼパム錠５ｍｇ「アメル」", "先発": "５ｍｇセルシン錠", "棚種類": "睡眠薬", "Note": "ー" }
{ "一般名称": "ジアゼパム錠", "後発/ジェネリック": "ジアゼパム錠２ｍｇ「アメル」", "先発": "２ｍｇセルシン錠", "棚種類": "睡眠薬", "Note": "ー" }

`;

    // ====== サニタイズ（行ごとJSON→配列） ======
    function sanitize(raw) {
      let lines = raw.split(/\r?\n/).map(s => s.trim());
      lines = lines.filter(s => s && s !== ',' && s !== '，');
      lines = lines.map(line => {
        line = line.replace(/，/g, ',');
        line = line.replace(/\t+/g, ' ').replace(/\s+$/, '');
        // Excelやコピペで全体が "{"..."}" になっている行を素直なJSONに戻す
        if (line.startsWith('"') && (line.endsWith('"') || line.endsWith('",'))) {
          if (line.endsWith('",')) line = line.slice(0, -2);
          if (line.endsWith('"'))  line = line.slice(0, -1);
          if (line.startsWith('"')) line = line.slice(1);
          line = line.replace(/""/g, '"');
        }
        if (line.startsWith('"{') && (line.endsWith('}"') || line.endsWith('}",'))) {
          line = line.replace(/^"\{/, '{').replace(/\}",?$/, '}').replace(/""/g, '"');
        }
        line = line.replace(/,\s*$/, '');
        return line;
      });
      lines = lines.filter(Boolean);
      const jsonText = `[${lines.join(',')}]`;
      try { return JSON.parse(jsonText); }
      catch (e) { console.error('変換失敗:', e, jsonText); alert('データ変換に失敗'); return []; }
    }
    const simpleData = sanitize(RAW);

    // ====== 正規化（旧/新フォーマット両対応） ======
    function normalizeFromSimple(arr){
      const emptyish = v => {
        const s = String(v ?? '').trim();
        return (!s || s === 'ー' || s === 'なし' || s === '先発品名なし') ? '' : s;
      };

      return arr.map(r=>{
        const general = emptyish(r["一般名称"] ?? r.general) || '(一般名未設定)';
        const genericName = emptyish(r["後発/ジェネリック"] ?? r.genericName);
        const brandName   = emptyish(r["先発"] ?? r.brandName);

        // 旧：棚①/棚②、新：棚種類（共通棚）をサポート
        const shelf1Old = emptyish(r["棚①"] ?? r["generic"] ?? r.shelf);
        const shelf2Old = emptyish(r["棚②"] ?? r["brandShelf"]);
        const shelfCommon = emptyish(r["棚種類"]); // 新フォーマット

        const shelf1 = shelf1Old || shelfCommon || 'ー';
        const shelf2 = shelf2Old || shelfCommon || 'ー';

        // 新フォーマットの Note を優先
        const note = (r["Note"] != null ? String(r["Note"]).trim() : '') || '';

        // 「後発/ジェネリック」が空 or 'なし' の扱い
        const genericDisplay = genericName || "後発品なし";

        return {
          general,
          variants: [
            { type: "後発", name: genericDisplay,        shelf: shelf1 },
            { type: "先発", name: brandName || "ー",       shelf: shelf2 }
          ],
          note
        };
      });
    }

    // ====== 状態 ======
    const data = normalizeFromSimple(simpleData);
    const input = document.getElementById('input');
    const suggestions = document.getElementById('suggestions');
    const selectedContainer = document.getElementById('selected');
    const savedDataContainer = document.getElementById('savedData');
    const saveBtn = document.getElementById('saveBtn');
    const csvBtn = document.getElementById('csvBtn');
    const resetBtn = document.getElementById('resetBtn');

    let selectedList = [];
    let savedDataList = [];

    // ====== 日本語正規化 ======
    function toKatakanaFromHiragana(str){
      return str.replace(/[\u3041-\u3096]/g, ch => String.fromCharCode(ch.charCodeAt(0)+0x60));
    }
    function normalizeJP(str){
      if (str == null) return "";
      return toKatakanaFromHiragana(String(str).normalize('NFKC'));
    }

    // ====== 検索 ======
    input.addEventListener('input', () => {
      const query = input.value.trim();
      suggestions.innerHTML = '';
      if (!query) return;
      const q = normalizeJP(query);
      const matches = data.filter(d => {
        const g = normalizeJP(d.general);
        const inVariants = (d.variants||[]).some(v => normalizeJP(v.name).includes(q));
        return g.includes(q) || inVariants;
      });
      matches.forEach(item => suggestions.appendChild(renderSuggestion(item)));
    });

    // ====== レンダリング ======
    function renderSuggestion(item){
      const li = document.createElement('li');
      const noteText = (item.note && item.note.trim()!=="") ? item.note : 'ー空欄';
      const lines = [`<strong>一般名:</strong> ${escapeHtml(item.general)}`];
      (item.variants || []).forEach((v, idx) => {
        lines.push(`${idx+1}) ${escapeHtml(v.type||'不明')} / ${escapeHtml(v.name||'（品名なし）')} / 棚: ${escapeHtml(v.shelf||'ー')}`);
      });
      lines.push(`Note: ${escapeHtml(noteText)}`);
      li.innerHTML = `<small>${lines.join('<br>')}</small>`;
      li.onclick = () => { selectItem(item); suggestions.innerHTML=''; input.value=''; };
      return li;
    }

    function renderSelected(){
      selectedContainer.innerHTML = '';
      selectedList.forEach((item, i) => {
        const noteText = (item.note && item.note.trim()!=="") ? item.note : 'ー空欄';
        const lines = [`<strong>一般名:</strong> ${escapeHtml(item.general)}`];
        (item.variants || []).forEach((v, idx) => {
          lines.push(`${idx+1}) ${escapeHtml(v.type||'不明')} / ${escapeHtml(v.name||'（品名なし）')} / 棚: ${escapeHtml(v.shelf||'ー')}`);
        });
        lines.push(`Note: ${escapeHtml(noteText)}`);
        const div = document.createElement('div');
        div.className = 'selected-item';
        div.innerHTML = `<small>${lines.join('<br>')}</small><span class="remove" onclick="removeItem(${i})">×</span>`;
        selectedContainer.appendChild(div);
      });
    }

    // ====== 選択・重複判定 ======
    function sameEntry(a,b){
      if(a.general!==b.general) return false;
      const av = a.variants||[], bv = b.variants||[];
      if(av.length!==bv.length) return false;
      return av.every((v,i)=> (v.type===bv[i].type && v.name===bv[i].name && v.shelf===bv[i].shelf));
    }
    function selectItem(item){
      if(selectedList.length >= 20){ alert("20件までしか選択できません。"); return; }
      if(selectedList.some(x => sameEntry(x, item))) return;
      selectedList.push(item); renderSelected();
    }
    function removeItem(index){ selectedList.splice(index, 1); renderSelected(); }

    // ====== 保存・表示 ======
    saveBtn.addEventListener('click', saveData);
    csvBtn.addEventListener('click', exportCSV);
    resetBtn.addEventListener('click', resetApp);

    function saveData(){
      const name = document.getElementById('personName').value.trim();
      if (!name) { alert("氏名を入力してください。"); return; }
      if (selectedList.length === 0) { alert("医薬品を1つ以上選択してください。"); return; }
      const entry = { name, medicines: [...selectedList] };
      savedDataList.push(entry);
      renderSavedData();
      document.getElementById('personName').value = '';
      selectedList = [];
      renderSelected();
    }

    function renderSavedData(){
      savedDataContainer.innerHTML = '';
      savedDataList.forEach((entry) => {
        const div = document.createElement('div');
        div.className = 'box';
        let html = `<strong>氏名:</strong> ${escapeHtml(entry.name)}<br><ul>`;
        entry.medicines.forEach(m => {
          const noteText = (m.note && m.note.trim()!=="") ? m.note : 'ー空欄';
          const lines = [`<strong>一般名:</strong> ${escapeHtml(m.general)}`];
          (m.variants||[]).forEach((v, idx) => {
            lines.push(`${idx+1}) ${escapeHtml(v.type||'不明')} / ${escapeHtml(v.name||'（品名なし）')} / 棚: ${escapeHtml(v.shelf||'ー')}`);
          });
          lines.push(`Note: ${escapeHtml(noteText)}`);
          html += `<li><small>${lines.join('<br>')}</small></li>`;
        });
        html += '</ul>';
        div.innerHTML = html;
        savedDataContainer.appendChild(div);
      });
    }

    // ====== CSV出力 ======
    function exportCSV(){
      if (savedDataList.length === 0) { alert("保存されたデータがありません。"); return; }
      let csv = '氏名,一般名,種類1,品名1,棚1,種類2,品名2,棚2,Note\n';
      savedDataList.forEach(entry=>{
        entry.medicines.forEach(m=>{
          const v1 = (m.variants||[])[0] || {};
          const v2 = (m.variants||[])[1] || {};
          const noteText = (m.note && m.note.trim()!=="") ? m.note : 'ー空欄';
          const row = [
            entry.name, m.general,
            v1.type||'', v1.name||'', v1.shelf||'',
            v2.type||'', v2.name||'', v2.shelf||'',
            noteText
          ].map(x=>`"${String(x||'').replace(/"/g,'""')}"`).join(',');
          csv += row + '\n';
        });
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = '保存医薬品一覧.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ====== リセット ======
    function resetApp(){
      if(!confirm('すべての選択・保存内容を消して最初からやり直しますか？')) return;
      input.value = '';
      document.getElementById('personName').value = '';
      suggestions.innerHTML = '';
      selectedList = [];
      savedDataList = [];
      renderSelected();
      renderSavedData();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ====== ユーティリティ ======
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => (
        { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]
      ));
    }
    window.removeItem = removeItem; // ×ボタン用
  </script>
</body>
</html>


